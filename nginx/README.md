# Nginx Reverse Proxy & Load Balancer Configuration

This directory contains the Nginx configuration for reverse proxy, load balancing, SSL/TLS, rate limiting, and health checks for the Opareta services.

## Features

- **Reverse Proxy**: Routes requests to auth and payments services
- **Load Balancing**: Distributes traffic across 2 instances of each service using least_conn algorithm
- **SSL/TLS**: Self-signed certificate for HTTPS (acceptable for development)
- **Rate Limiting**: 100 requests per minute per IP address
- **Health Checks**: Dedicated endpoints for service health monitoring
- **Access Logging**: Comprehensive logging of all requests

## Directory Structure

```
nginx/
├── nginx.conf              # Main Nginx configuration
├── conf.d/
│   └── opareta.conf        # Site-specific configuration
├── ssl/
│   ├── opareta.crt         # SSL certificate
│   └── opareta.key         # SSL private key
├── logs/                   # Nginx access and error logs
├── Dockerfile              # Nginx container definition
├── generate-ssl.sh         # Script to generate self-signed certificate
└── README.md               # This file
```

## Configuration Details

### Load Balancing

- **Round-Robin Load Balancing**: Uses Docker Compose DNS round-robin for load distribution
- **Auth Service**: Load balanced across all scaled instances via Docker DNS
- **Payments Service**: Load balanced across all scaled instances via Docker DNS
- **Scaling**: Use `docker-compose up --scale auth=2 --scale payments=2` to run 2 instances
- **Automatic**: No manual configuration needed - Docker DNS handles distribution automatically
- **Health Checks**: Automatic failover with `max_fails=3` and `fail_timeout=30s`
- **Keepalive**: Connection pooling with `keepalive 32` for better performance

### Rate Limiting

- **API Endpoints**: 100 requests per minute per IP (with burst of 20)
- **Health Check Endpoints**: 10 requests per second per IP (with burst of 20)
- **Response**: HTTP 429 (Too Many Requests) when limit exceeded

### SSL/TLS

- **Protocols**: TLSv1.2 and TLSv1.3
- **Certificate**: Self-signed (generated by `generate-ssl.sh`)
- **Ports**: HTTP (80) redirects to HTTPS (443)

### Health Check Endpoints

- **Nginx Health**: `http://localhost/nginx-health` or `https://localhost/nginx-health`
- **Auth Service**: `http://localhost/auth/health` or `https://localhost/auth/health`
- **Payments Service**: `http://localhost/payments/health` or `https://localhost/payments/health`

### Service Routes

- **Auth Service**: `https://localhost/auth/*`
- **Payments Service**: `https://localhost/payments/*`

## Setup Instructions

1. **Generate SSL Certificate** (if not already generated):
   ```bash
   cd nginx
   ./generate-ssl.sh
   ```

2. **Start Services with Scaling** (2 instances of each service):
   ```bash
   docker-compose up -d --scale auth=2 --scale payments=2
   ```

   Or start normally (1 instance each):
   ```bash
   docker-compose up -d
   ```

   **Note**: Docker Compose DNS automatically handles load balancing - no additional configuration needed!

3. **Verify Nginx is Running**:
   ```bash
   curl http://localhost/nginx-health
   ```

4. **Test Health Checks**:
   ```bash
   curl http://localhost/auth/health
   curl http://localhost/payments/health
   ```

5. **Test HTTPS** (accept self-signed certificate):
   ```bash
   curl -k https://localhost/auth/health
   curl -k https://localhost/payments/health
   ```

4. **Scale Services Dynamically**:
   ```bash
   docker-compose up -d --scale auth=3 --scale payments=3
   ```
   Docker DNS automatically updates - no Nginx reload needed!

## Logs

Access logs are stored in:
- `/var/log/nginx/access.log` - General access log
- `/var/log/nginx/opareta-access.log` - Site-specific access log
- `/var/log/nginx/health-access.log` - Health check access log
- `/var/log/nginx/error.log` - Error log
- `/var/log/nginx/opareta-error.log` - Site-specific error log

Logs are mounted to `./nginx/logs/` on the host.

## Security Headers

The following security headers are configured:
- `Strict-Transport-Security`: Enforces HTTPS
- `X-Frame-Options`: Prevents clickjacking
- `X-Content-Type-Options`: Prevents MIME type sniffing
- `X-XSS-Protection`: Enables XSS protection

## Notes

- The self-signed certificate will show a browser warning. This is expected for development.
- For production, replace the self-signed certificate with a valid certificate from a CA.
- Rate limiting is applied per IP address. Consider using a shared rate limit zone with Redis for distributed systems.
- Health checks bypass the main rate limiting but have their own limit to prevent abuse.
- Load balancing uses Docker Compose DNS round-robin - simple and automatic, no manual configuration needed.

